# API Reference (MVP)

This reference covers the minimal API surface for the MVP. It uses JSON for requests and responses unless noted.

## Conventions

- `id` values are strings. All IDs are generated by the client (UUID v4 recommended). The server treats IDs as opaque strings and never assigns them.
- Responses use standard HTTP status codes.
- WebSocket messages are JSON objects with a `type` field.
- Pixel ranges are 0-indexed (`start: 0` is the first pixel).

## Health

### GET /health

Response:

```json
{ "status": "ok" }
```

## Channels

### GET /channels

Response:

```json
[
  {
    "id": "channel-1",
    "name": "Main Strand",
    "gpioPin": 18,
    "ledCount": 600,
    "ledType": "ws281x",
    "colorOrder": "RGB"
  }
]
```

### POST /channels

Creates or replaces a channel by `id` (upsert).

Request:

```json
{
  "id": "channel-1",
  "name": "Main Strand",
  "gpioPin": 18,
  "ledCount": 600,
  "ledType": "ws281x",
  "colorOrder": "RGB"
}
```

Response:

```json
{ "ok": true }
```

## Hardware Test

These endpoints send test signals directly to hardware outside of any play or live session. Test signals auto-timeout after `HARDWARE_TEST_TIMEOUT_SEC` seconds, turning all affected LEDs off. A signal is also cleared when any preview or live session starts, or when an explicit off command is sent.

### POST /channels/{id}/test/white

Fills all LEDs on the channel with white. Useful for verifying a strand is wired and powered correctly.

Response:

```json
{ "ok": true }
```

### POST /channels/{id}/test/off

Turns off all LEDs on the channel immediately, without waiting for the timeout.

Response:

```json
{ "ok": true }
```

### POST /plays/{id}/regions/{regionId}/test

Lights up the region in white to help locate its physical position on the strand.

Response:

```json
{ "ok": true }
```

## Plays

### GET /plays

Response:

```json
[
  { "id": "play-1", "name": "Main Stage" }
]
```

### POST /plays

Request:

```json
{
  "id": "play-1",
  "name": "Main Stage",
  "regions": [],
  "cues": []
}
```

Returns 400 if any region's ranges overlap each other, or if any two regions assigned to the same cue have ranges that overlap on the same channel.

Response:

```json
{ "ok": true }
```

### GET /plays/{id}

Response:

```json
{
  "id": "play-1",
  "name": "Main Stage",
  "regions": [
    { "id": "region-1", "name": "Stage Left", "channelId": "channel-1", "ranges": [{ "start": 0, "end": 149 }] }
  ],
  "cues": [
    { "id": "cue-1", "name": "Intro", "effectsByRegion": { "region-1": { "id": "effect-1", "type": "fade_in", "params": { "durationSec": 1.2, "color": "#ffffff" } } } }
  ]
}
```

### PUT /plays/{id}

Request:

```json
{
  "id": "play-1",
  "name": "Main Stage",
  "regions": [
    { "id": "region-1", "name": "Stage Left", "channelId": "channel-1", "ranges": [{ "start": 0, "end": 149 }] }
  ],
  "cues": [
    { "id": "cue-1", "name": "Intro", "effectsByRegion": { "region-1": { "id": "effect-1", "type": "fade_in", "params": { "durationSec": 1.2, "color": "#ffffff" } } } }
  ]
}
```

Returns 400 if any region's ranges overlap each other, or if any two regions assigned to the same cue have ranges that overlap on the same channel.

Response:

```json
{ "ok": true }
```

### DELETE /plays/{id}

Response:

```json
{ "ok": true }
```

## Preview

Preview and live are global sessions — only one of each can run at a time across all plays.

### GET /preview/status

Returns the current preview session state. Returns `isRunning: false` and `playId: null` if no preview session is active.

Response:

```json
{ "isRunning": true, "playId": "play-1" }
```

When no session is active:

```json
{ "isRunning": false, "playId": null }
```

### POST /preview

Starts preview rendering for a play from the first cue. If a preview session is already running, it is stopped and replaced. All clients connected to the WebSocket stream begin receiving frames from the new start.

Request:

```json
{ "playId": "play-1" }
```

Response:

```json
{ "ok": true }
```

### POST /preview/next

Advances the preview to the next cue. Has no effect if the last cue is already active.

Response:

```json
{ "ok": true }
```

### POST /preview/stop

Stops the preview session. The server sends a `done` WebSocket message and closes the stream.

Response:

```json
{ "ok": true }
```

### WS /preview/stream

Clients may connect at any time. If a preview is already in progress, the client begins receiving frames from the current position. Multiple clients may be connected simultaneously — all receive the same frames.

Frame message:

```json
{
  "type": "frame",
  "timestamp": 1700000000,
  "channels": {
    "channel-1": ["#000000", "#ff0000"],
    "channel-2": ["#000000", "#00ff00"]
  }
}
```

## Live Mode

Cue advancement is manual. The operator calls `POST /live/next` to move to the next cue. Cues run indefinitely until advanced or stopped.

### GET /live/status

Returns the current live session state. Returns `isRunning: false` with null fields if no live session is active.

Response:

```json
{
  "isRunning": true,
  "playId": "play-1",
  "cueId": "cue-1",
  "cueName": "Intro",
  "cueIndex": 0,
  "isBlackout": false
}
```

### POST /live/start

Starts a live session for a play from the first cue. Returns 409 if a live session is already running. Only one live session may run at a time.

Request:

```json
{ "playId": "play-1" }
```

Response:

```json
{ "ok": true }
```

### POST /live/next

Advances to the next cue. Has no effect if the last cue is already active.

Response:

```json
{ "ok": true }
```

### POST /live/stop

Stops the current live session and turns off all hardware output.

Response:

```json
{ "ok": true }
```

### POST /live/blackout

Activates blackout, overriding hardware output with all-black on all channels. The session continues running. Calling `/live/next` clears the blackout and advances to the next cue.

Response:

```json
{ "ok": true }
```

### WS /live/stream

Clients may connect at any time. Upon connection, the server immediately sends a `status` message with the current session state. Multiple clients may be connected simultaneously — all receive the same messages.

Status message:

```json
{
  "type": "status",
  "playId": "play-1",
  "cueId": "cue-1",
  "cueName": "Intro",
  "cueIndex": 0,
  "isRunning": true,
  "isBlackout": false
}
```

Frame message:

```json
{
  "type": "frame",
  "timestamp": 1700000000,
  "channels": {
    "channel-1": ["#000000", "#ff0000"],
    "channel-2": ["#000000", "#00ff00"]
  }
}
```

## Import and Export

### POST /plays/{id}/export

Writes the play to the exports directory and returns the generated filename.

Response:

```json
{ "ok": true, "name": "play-1-1700000000.json", "path": "/var/lib/pilites/exports/plays/play-1-1700000000.json" }
```

### GET /plays/{id}/export/{filename}

Downloads an exported play file as an attachment.

Response: file attachment (`application/json`)

### POST /plays/import/upload

Uploads a play JSON file and stages it in the imports directory. Returns the staged filename for use with the import endpoint.

Request: multipart form upload with a `file` field.

Response:

```json
{ "ok": true, "name": "play-1-1700000000.json" }
```

### POST /plays/{id}/import

Applies a staged import file, replacing or creating the play at `{id}`. The URL `{id}` is authoritative — the stored play's `id` field is set to match, overriding whatever `id` is in the file. This allows importing a play from another system under a new ID without editing the file.

Request:

```json
{ "name": "play-1-1700000000.json" }
```

Response:

```json
{ "ok": true }
```

## Backup and Restore

### GET /plays/{id}/backups

Response:

```json
[
  { "name": "play-1-1700000000.json", "path": "/var/lib/pilites/backups/plays/play-1/play-1-1700000000.json" }
]
```

### POST /plays/{id}/backup

Response:

```json
{ "ok": true, "path": "/var/lib/pilites/backups/plays/play-1/play-1-1700000000.json" }
```

### POST /plays/{id}/restore

Request:

```json
{ "name": "play-1-1700000000.json" }
```

Response:

```json
{ "ok": true }
```
